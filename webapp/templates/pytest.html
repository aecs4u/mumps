{% extends "base.html" %}

{% block title %}MUMPS Python Interface - Test Results{% endblock %}

{% block content %}
<div class="hero">
  <h1>ğŸ§ª Python Interface Test Results</h1>
  <p class="lead">
    pytest test suite results for MUMPS Python ctypes interface
    {% if latest_session %}
    - Latest run: {{ latest_session.timestamp }}
    {% endif %}
  </p>
</div>

<!-- Latest Session Highlights -->
{% if latest_session %}
<div class="kpi-section">
  <h2>ğŸ“Š Latest Test Session</h2>
  <div class="kpi-grid">
    <div class="kpi-card {% if latest_session.num_failed == 0 %}success{% else %}danger{% endif %}">
      <div class="kpi-value">{{ latest_session.num_passed or 0 }} / {{ latest_session.num_tests or 0 }}</div>
      <div class="kpi-label">Tests Passed</div>
      <div class="kpi-progress">
        <div class="progress-bar" style="width: {{ (latest_session.num_passed / latest_session.num_tests * 100) if (latest_session.num_tests and latest_session.num_tests > 0) else 0 }}%;"></div>
      </div>
      <div class="kpi-detail">
        {% if latest_session.blas_vendor %}{{ latest_session.blas_vendor }} vendor{% endif %}
      </div>
    </div>

    <div class="kpi-card {% if (latest_session.num_failed or 0) > 0 %}warning{% else %}success{% endif %}">
      <div class="kpi-value">{{ latest_session.num_failed or 0 }}</div>
      <div class="kpi-label">Failed Tests</div>
      <div class="kpi-icon">{% if (latest_session.num_failed or 0) > 0 %}âœ—{% else %}âœ“{% endif %}</div>
    </div>

    <div class="kpi-card info">
      <div class="kpi-value">{{ "%.2f"|format(latest_session.total_duration or 0) }}s</div>
      <div class="kpi-label">Total Duration</div>
      <div class="kpi-icon">â±ï¸</div>
    </div>

    <div class="kpi-card primary">
      <div class="kpi-value">{{ latest_session.python_version or 'N/A' }}</div>
      <div class="kpi-label">Python Version</div>
      <div class="kpi-detail">{{ latest_session.platform or 'Unknown platform' }}</div>
    </div>
  </div>
</div>
{% else %}
<div class="alert info">
  <p><strong>No test sessions found.</strong> Run <code>./scripts/run_tests.sh</code> or <code>./scripts/test_all_vendors.sh</code> to generate test results.</p>
</div>
{% endif %}

<!-- Overall Statistics -->
{% if sessions %}
<div class="section">
  <h2>ğŸ“ˆ Overall Statistics</h2>
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value">{{ total_tests }}</div>
      <div class="stat-label">Total Tests Run</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ test_status.passed }}</div>
      <div class="stat-label">Passed</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ test_status.failed }}</div>
      <div class="stat-label">Failed</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ test_status.skipped }}</div>
      <div class="stat-label">Skipped</div>
    </div>
  </div>

  {% if vendors %}
  <div class="vendor-section">
    <h3>ğŸ”§ Tested BLAS Vendors</h3>
    <div class="vendor-badges">
      {% for vendor in vendors %}
      <span class="badge vendor-badge">{{ vendor }}</span>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<!-- Recent Test Sessions -->
<div class="section">
  <h2>ğŸ“‹ Recent Test Sessions</h2>
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Vendor</th>
          <th>Tests</th>
          <th>Passed</th>
          <th>Failed</th>
          <th>Skipped</th>
          <th>Duration</th>
          <th>Pass Rate</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for session in sessions %}
        <tr class="{% if (session.num_failed or 0) > 0 %}row-warning{% endif %}">
          <td>{{ session.timestamp }}</td>
          <td>
            <span class="badge">{{ session.blas_vendor or 'default' }}</span>
          </td>
          <td>{{ session.num_tests or 0 }}</td>
          <td class="success-text">{{ session.num_passed or 0 }}</td>
          <td class="{% if (session.num_failed or 0) > 0 %}danger-text{% endif %}">
            {{ session.num_failed or 0 }}
          </td>
          <td class="muted-text">{{ session.num_skipped or 0 }}</td>
          <td>{{ "%.2f"|format(session.total_duration or 0) }}s</td>
          <td>
            <div class="progress-mini">
              <div class="progress-bar-mini {% if (session.num_failed or 0) > 0 %}warning{% else %}success{% endif %}"
                   style="width: {{ ((session.num_passed or 0) / (session.num_tests or 1) * 100) if (session.num_tests and session.num_tests > 0) else 0 }}%;">
              </div>
            </div>
            <span class="progress-label-mini">
              {{ "%.1f"|format(((session.num_passed or 0) / (session.num_tests or 1) * 100) if (session.num_tests and session.num_tests > 0) else 0) }}%
            </span>
          </td>
          <td>
            <a href="/pytest/{{ session.id }}" class="btn btn-sm btn-primary">View Details</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div class="alert warning">
  <p><strong>No test sessions available.</strong> The pytest database appears to be empty.</p>
  <p>To generate test results:</p>
  <ul>
    <li><code>./scripts/run_tests.sh</code> - Run tests with default BLAS</li>
    <li><code>./scripts/test_all_vendors.sh</code> - Run tests for all available vendors</li>
  </ul>
</div>
{% endif %}

<!-- Help Section -->
<div class="section help-section">
  <h2>â„¹ï¸ About Python Interface Testing</h2>
  <div class="help-content">
    <p>
      The MUMPS Python interface uses <strong>pytest</strong> to validate the ctypes bindings
      against scipy.sparse reference solvers. All test results are stored in
      <code>mumps.sqlite</code> database for tracking and analysis.
    </p>
    <div class="help-grid">
      <div class="help-card">
        <h4>ğŸ¯ Test Coverage</h4>
        <ul>
          <li>Basic functionality (identity, diagonal, tridiagonal)</li>
          <li>Precision tests (random SPD, ill-conditioned)</li>
          <li>Symmetry modes (unsymmetric, SPD, general symmetric)</li>
          <li>scipy.sparse validation (spsolve, splu)</li>
          <li>Error handling (singular matrix, dimension mismatch)</li>
          <li>Control parameters (ICNTL, CNTL)</li>
          <li>Performance benchmarks</li>
        </ul>
      </div>
      <div class="help-card">
        <h4>ğŸ”§ Running Tests</h4>
        <pre><code># Single vendor (default)
./scripts/run_tests.sh

# All available vendors
./scripts/test_all_vendors.sh

# Rebuild vendor libraries
./scripts/rebuild_vendor_libraries.sh</code></pre>
      </div>
    </div>
  </div>
</div>

{% endblock %}
